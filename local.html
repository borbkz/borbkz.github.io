<!DOCTYPE html>

<head>
	<title>Borb's KZ</title>

	<link rel="stylesheet" type="text/css" href="styles/style.css">
	<link rel="stylesheet" type="text/css"
		href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js">
	</script>
	<script type="text/javascript" src="utils/utils.js"></script>
	<script>
		var difficultyArray = {};
		var headerArray = ["Map", "Tier", "Pro Tier", "Length", "TP Time", "Teleports", "TP Rank", "Pro Time",
			"Pro Teleports", "Pro Rank"
		];
		var plugin;

		var table;
		$(document).ready(function () {
			difficultyArray = getDifficultyArray();
			var beginOffset = 2;

			$("#downloadButton").click(function () {
				var csvText = headerArray.join(",") + "\r\n";
				if (typeof outputBuffer !== 'undefined') {
					for (i = 0; i < outputBuffer.length; i++)
						csvText += outputBuffer[i];
				}
				this.href = "data:text/plain;charset=UTF-8," + encodeURIComponent(csvText);
			});
			$("#convertButton").click(function () {

				var textIn = $("#inputMapsTextArea");
				//var textOut = $("#outputMapsTextArea");

				$.each(textIn.val().split("\n"), function (i, line) {
					if (!(/.+,.+,.+,.+$/.test(line))) {
						return true;
					}
					mapInfo = line.split(",");
					//[mapname][difficulty, TP time, TP Teleports, TP Rank, Pro time, PRO teleports, Pro Rank]		 
					offset = beginOffset + (mapInfo[1].includes("(PRO)") ? 3 :
						0);
					mapName = mapInfo[0];

					if (mapName in difficultyArray) {
						writeToArray(mapInfo, difficultyArray[mapName], offset);
					} else {
						temp = [difficultyArray[mapName]];
						writeToArray(mapInfo, temp, offset);
						difficultyArray[mapName] = temp;
					}


				});

				function writeToArray(arrIn, arrOut, offset) {
					for (i = 1; i < 4; i++) {
						arrOut[i + offset] = arrIn[i].replace(/Time: /g, '').replace(/Teleports: /g, '')
							.replace(/Rank: /g, '');
					}
				}
				printAllMaps();

				function test2() {

				}

				function printAllMaps() {
					//clear area first
					//textOut[0].value = "";

					outputBuffer = [""];
					tableBuffer = [];

					//finishedStatus = $('input[name=finishedStatus]:checked').val();
					//unfinishedStatus = $('input[name=unfinishedStatus]:checked').val();
					for (var map in difficultyArray) {



						line = map + ", " + difficultyArray[map];
						outputBuffer.push(map + ", " + difficultyArray[map] + "\n");

						length = difficultyArray[map].length;
						row = line.split(",");

						for (i = length; i < (headerArray.length - 1); i++) {
							row.push("");
						}
						tableBuffer.push(row);

					}
					/*
					textOut[0].value += headerArray+"\n";

					for(i = 0; i < outputBuffer.length; i++){
						textOut[0].value += outputBuffer[i];
						textOut[0].value +=difficultyArray[map].length + " | " + map + ", " + difficultyArray[map] + "\n";
					}*/
					var spreadsheetContainer = $("#spreadsheet")[0];

					cols = [{}, //map name
						{}, //tier
						{}, //pro tier
						{}, //length
						{
							type: "time",
							timeFormat: "h:mm:ss"
						},
						{}, //tp
						{}, //tp rank
						{
							type: "time",
							timeFormat: "h:mm:ss"
						},
						{}, //pro teleports
						{} //pro rank
					];
					//filters for map, tp&pro tiers, length, tp& pro times

					table = genTable(spreadsheetContainer, tableBuffer, headerArray, [0], cols);
					plugin = table.getPlugin('hiddenColumns');

					//if (typeof mapTable !== "undefined")
					//mapTable.updateSettings({ data: [] }); //clear table after click


				}


			}); //end click
		}); //end ready
	</script>


</head>

<body>
	<div class="nav-container">
		<ul>
			<li><a href="index.html">Global Times</a></li>
			<li><a class="active" href="local.html">Local Times</a></li>
			<li><a href="jumpstats.html">Jumpstats</a></li>
			<li><a href="contact.html">Contact</a></li>
		</ul>
		<div class="center">



			<div class="textDiv">

				<div id="titleDiv">
					<div id="innerTitleDiv">
						<h2> Local Maps Organizer</h2>
					</div>
				</div>

				<textarea rows="10" cols="100" id="inputMapsTextArea">
On any KZTimer enabled server, type !profile in the chat and select "finished maps" 
Paste your times here.

Example:

kz_11342, Time: 01:29.58 (PRO), Teleports: 0, Rank: 1/2
kz_11342, Time: 01:29.95 (TP), Teleports: 1, Rank: 1/18
kz_11735, Time: 01:29.82 (TP), Teleports: 4, Rank: 1/21
kz_11735, Time: 01:29.63 (PRO), Teleports: 0, Rank: 1/7
</textarea>

				<div class="inputSelection">
					<div class="innerSelection">
					<input class="toggle" data-column="1" type="checkbox" checked>TP Tier
					<input class="toggle" data-column="2" type="checkbox" checked>Pro Tier
					<input class="toggle" data-column="3" type="checkbox" checked>Length
					<input class="toggle" data-column="4" type="checkbox" checked>TP Times
					<input class="toggle" data-column="5" type="checkbox" checked>Teleports
					<input class="toggle" data-column="6" type="checkbox" checked>TP Rank
					<input class="toggle" data-column="7" type="checkbox" checked>Pro Times
					<input class="toggle" data-column="8" type="checkbox" checked>Pro Teleports
					<input class="toggle" data-column="9" type="checkbox" checked>Pro Rank
					</div>

					<div class="innerSelection">

						<button id="convertButton">Generate Spreadsheet</button>
						<a id="downloadButton" href="" download="kzmaps.csv"><button>Download CSV</button></a>

					</div>
				</div>
				<!-- <textarea  rows="20" cols="100" id="outputMapsTextArea"></textarea>-->

				<div class="table-container">


						<div id="example" class="handsontable"></div>

					<div class="handsontable" id="spreadsheet">
					</div>

				</div>
			</div>
		</div>
</body>

</html>
