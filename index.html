<!DOCTYPE html>

<head>
	<title>Borb's KZ</title>

	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

	<link rel="stylesheet" type="text/css"
		href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
		integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="styles/styles.css?v=2">

	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js">
	</script>
	<script type="text/javascript" src="utils/util.js?v=2"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
		integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous">
	</script>

	<script>
		var imagepath = "img/";
		var playerMax = 20; //20 players, not 20 records, each player may have a bunch of incremental times
		var globalsRequestURLBase =
			"https://kztimerglobal.com/api/v1.0/records/top/recent?stage=0&tickrate=128&modes_list_string=kz_timer";

		var top1RequestURL = globalsRequestURLBase + "&place_top_at_least=1&limit=40";
		var top20RequestURL = globalsRequestURLBase +
			"&place_top_at_least=20&limit=40"; //#1 counts as top 20, get 50 just in case
		var top100RequestURL = globalsRequestURLBase + "&limit=100";



		//using player_name+map_name+teleports as hash
		var top1Players = {};
		var top20Players = {};
		var top100Players = {};

		var globalURLs = {
			"gold": top1RequestURL,
			"silver": top20RequestURL,
			"bronze": top100RequestURL,
		}


		for (var ranking in globalURLs) {



			$.getJSON(globalURLs[ranking], (function (ranking) {
				return function (data) {

					var maps = [];
					var recordEntries = [];
					var playerArr = top1Players;
					var playerContainer = $('#top-1-container')[0];



					$.each(data, function (i, field) {

						var player = field["player_name"],
							place = parseInt(field["place"]),
							map = field["map_name"],
							time = field["time"];

							field["medal"] = "gold";

						if (place == 1) {
							playerContainer = $('#top-1-container')[0];
							playerArr = top1Players;
							field["medal"] = "gold";

						}
						else if (place > 1 && place < 20) {
							playerContainer = $('#top-20-container')[0];
							playerArr = top20Players;
							field["medal"] = "silver";
						} else if (place > 20) {
							playerContainer = $('#top-100-container')[0];
							playerArr = top100Players;
							field["medal"] = "bronze";
						}


						if (Object.keys(playerArr).length < playerMax) {
							pushPlayer(playerArr, field);
						}

					}); //.each
					publishPlayerTimes(playerContainer, playerArr);
				}
			})(ranking));

		}

		function pushPlayer(playerList, playerRecord) {
			var teleports = parseInt(playerRecord["teleports"]);
			var isPro = "TP";
			if (teleports === 0)
				isPro = "PRO";


			playerKey = playerRecord["player_name"] + "+" +
				playerRecord["map_name"] + "+" + isPro;

			if (playerKey in playerList) {
				playerList[playerKey].push(playerRecord);
			} else {
				playerList[playerKey] = [playerRecord];
			}

		}

		function publishPlayerTimes(recordContainer, playerEntries) {

			for (var playerKey in playerEntries) {
				//player:[record1, record2, record3]

				var bestTime = parseFloat(playerEntries[playerKey][0]["time"]);
				var prevTime = bestTime;


				for (var i = 0; i < playerEntries[playerKey].length; i++) {
					var recordTimeText = "";
					var indent = i == 0 ? 0 : 10 + 4 * i;

					var timeDiff = "";
					if (i < playerEntries[playerKey].length - 1) {

						prevTime = parseFloat(playerEntries[playerKey][i + 1]["time"]);
						timeDiff = Math.abs(bestTime - prevTime);
						bestTime = prevTime;
					}


					publishEntry(recordContainer, playerEntries[playerKey][i], indent, timeDiff);

				}
			}
		}

		function publishEntry(recordContainer, recordEntry, indentLevel, timeMinusInSeconds) {

			indentLevel = 0 || indentLevel;
			var preName = sanitizeName(recordEntry["player_name"]);
			var player = preName.substring(0, 20) + (preName.length > 20 ? " ..." : ""),
				steamID = recordEntry["steam_id"],
				place = parseInt(recordEntry["top_100"]),
				map = recordEntry["map_name"],
				time = getTimeFromSeconds(recordEntry["time"]),
				teleports = recordEntry["teleports"],
				teleportsBool = parseInt(teleports) > 0,
				runtype = recordEntry["teleports"] == 0 ? "PRO" : "TP",
				date = recordEntry["created_on"],
				updatedOn = recordEntry["updated_on"],
				medal = recordEntry["medal"]

			var nameLink = '<a href="local.html?steamid=' + steamID + "&teleports=" + teleportsBool + '">' + player + '</a>'


			var recordTimeText = "";

			var timeFinished = getTimeAgo(date);
			if (timeMinusInSeconds != 0)
				recordTimeText = '<span class="record-minus-time"> ( -' + getTimeFromSeconds(timeMinusInSeconds) + ')</span>';


			var runtypeText = '<span class="' + runtype.toLowerCase() + '-type-container">' + runtype + '</span>';
			var timeText = '<span class="' + runtype.toLowerCase() + '-run-container">' + time + '</span>';
			var placeText = '<span class="' + medal + '-place-container">#' + place + '</span>';
			var playerText = '<span class="player-name-container">' + nameLink + "</span>";
			var mapText = '<span class="map-name-container">' + map + "</span>"
			var dateText = '<span class="date-run-container"> ' + timeFinished + (timeFinished === "" ? "" : " ago") +
				"</span>";

			var medalURL = imagepath + medal + "-medal.png";
			var medalTag = '<img class="medal-icon" src="' + medalURL + '">' + placeText + " </img>";

			var recordText = playerText + " placed " + medalTag + " " + runtypeText + " on " + mapText + " " +
				" with a time " + " of " +
				timeText + recordTimeText + dateText;

			if (indentLevel != 0) {
				recordText = player + " finished with " + timeText + recordTimeText + dateText;

			}
			//var recordText = playerText + " placed ";

			var recordDivClass = "record-text-container";


			var indentText = "";
			for (var i = 0; i < indentLevel; i++) {
				indentText += "&nbsp";
			}
			var indentHTML = '<span class="record-indent">' + indentText + '</span>';
			var recordHTML = '<div class="' + recordDivClass + '">' + indentHTML + recordText +
				'<br></div>';

			$(recordContainer).append(recordHTML);



		}

		//input format : YYYY-MM-DDTHH:MM:SS
		//output format : X Days, Y Hours;
		function getTimeAgo(time) {
			var mapTime = new Date(time);
			var curTime = new Date();


			curTime.setHours(curTime.getHours() + 7);

			//what fucking timee zone is this
			var remainingTime = Math.abs(curTime - mapTime);

			var days = Math.floor(remainingTime / (24 * 60 * 60 * 1000.0));
			remainingTime -= days * (24 * 60 * 60 * 1000);
			var hours = Math.floor(remainingTime / (60 * 60 * 1000.0));
			remainingTime -= hours * (60 * 60 * 1000);
			var minutes = Math.floor(remainingTime / (60 * 1000.0));

			var daysText = days > 0 ? days + " days " : "";
			var hoursText = hours > 0 ? hours + " hours " : "";
			var minutesText = minutes > 0 ? minutes + " minutes " : "";

			return daysText + hoursText + minutesText;
		};
	</script>


</head>

<body>

	<div class="page-container">


		<ul>
			<li><a class="active" href="index.html">Global Times</a></li>
			<li><a href="local.html">Your Times</a></li>
			<li><a href="maps.html">Maps</a></li>
			<li><a href="jumpstats.html">Jumpstats</a></li>
		</ul>
		<div class="content-wrap">



			<div class="accordion" id="accordion-times">
				<div class="card">
					<div class="card-header" id="headingGlobal">
						<h5 class="mb-0">
							<button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne"
								aria-expanded="true" aria-controls="collapseOne" id="expandTop1">
								<h4 id="global-player-name">Recent Global World Records</h4>
							</button>
						</h5>
					</div>

					<div id="collapseOne" class="show" aria-labelledby="headingGlobal" data-parent="#accordion-times">
						<div class="card-body">

							<div class="content-wrap" id="top-1-container" style="text-align: left">


							</div>
						</div>
					</div>
				</div>

				<div class="card">
					<div class="card-header" id="headingTop20">
						<h5 class="mb-0">
							<button class="btn btn-link collapsed" type="button" data-toggle="collapse"
								data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo"
								id="expandTop20">
								<h4>Recent Global Top 20 Times</h4>
							</button>
						</h5>
					</div>
					<div id="collapseTwo" class="collapse" aria-labelledby="headingLocal"
						data-parent="#accordion-times">
						<div class="card-body">

							<div class="content-wrap" id="top-20-container" style="text-align:left">



							</div>
						</div>
					</div>
				</div>

				<div class="card">
					<div class="card-header" id="headingTop100">
						<h5 class="mb-0">
							<button class="btn btn-link" type="button" data-toggle="collapse"
								data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree"
								id="expandTop100">
								<h4 id="global-player-name">Recent Global Top 100 Times</h4>
							</button>
						</h5>
					</div>

					<div id="collapseThree" class="collapse" aria-labelledby="headingGlobal"
						data-parent="#accordion-times">
						<div class="card-body">

							<div class="content-wrap" id="top-100-container" style="text-align:left">


							</div>
						</div>
					</div>
				</div>
			</div>
		</div>




		<footer class="container">
			<hr>
			<div class="text-center center-block">
				<a href="https://github.com/borbkz"><i id="social-github"
						class="fa fa-github-square fa-3x social"></i></a>
				<a href="https://steamcommunity.com/id/borbkz"><i id="social-steam"
						class="fa fa-steam-square fa-3x social"></i></a>
				<a href="mailto:borbkz@gmail.com"><i id="social-em" class="fa fa-envelope-square fa-3x social"></i></a>
			</div>

		</footer>





	</div>
</body>

</html>
