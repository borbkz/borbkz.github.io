<!DOCTYPE html>

<head>
	<title>Borb's KZ</title>
	<link rel="stylesheet" type="text/css" href="styles/style.css">
	<link rel="stylesheet" type="text/css"
		href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js">
	</script>
	<script type="text/javascript" src="utils/utils.js"></script>

	<script>
		var mapTable;
		$(document).ready(function () {
			var header = ["Map", "Tier", "Time", "TP", "Pts", "Date", "Server"];
			var mapRequestBaseURL = "https://kztimerglobal.com/api/v1.0/records/top?"

			URI = getURIVars();
			steamID = "";
			if (typeof URI["steamid"] !== 'undefined' && URI["teleports"] !== 'undefined') {
				steamID = URI["steamid"];
				teleports = URI["teleports"]
				if (isValidSteamID(steamID)) {

					$('#steamIDText').val(steamID);

					if(teleports === "true")
						retrieveStats(steamID, true);
					else if (teleports === "false")
						retrieveStats(steamID, false);

				}
			}

			function retrieveStats(steamID, teleports) {
				//temp max limit based on ~440 maps, eventually should change to indexdb storage 
				//so you dont fetch every map all the time, and just fetch the latest runs
				var tempLimit = 500;
				requestURL = "https://kztimerglobal.com/api/v1.0/records/top?steam_id=" + steamID +
					"&tickrate=128&stage=0&has_teleports=" + teleports + "&limit=" + tempLimit +
					"&modes_list_string=kz_timer";

				$.getJSON(requestURL, function (data) {
					var maps = [];
					$("#playername").text("Player: " + data[0]["player_name"])
					$.each(data, function (i, field) {

						//server is sometimes null, and throws exception
						server = "N/A"; 
						if(typeof field["server_name"] === "string"){
							server = field["server_name"].substring(0,35);
						}
						var statRow = [field["map_name"], "N/A",
							getTimeFromSeconds(field["time"]), field["teleports"], field[
								"points"],
							field["updated_on"], server
						];
						maps.push(statRow);
						//createTable(maps, header);


					}); //.each
					var debounceFn = Handsontable.helper.debounce(function (colIndex, event) {
						var filtersPlugin = mapTable.getPlugin('filters');

						filtersPlugin.removeConditions(colIndex);
						filtersPlugin.addCondition(colIndex, 'contains', [event.realTarget.value]);
						filtersPlugin.filter();
					}, 200);

					var addEventListeners = function (input, colIndex) {
						input.addEventListener('keydown', function (event) {
							debounceFn(colIndex, event);
						});
					};

					// Build elements which will be displayed in header.
					var getInitializedElements = function (colIndex) {
						var div = document.createElement('div');
						var input = document.createElement('input');

						div.className = 'filterHeader';

						addEventListeners(input, colIndex);

						div.appendChild(input);

						return div;
					};

					// Add elements to header on `afterGetColHeader` hook.
					var addInput = function (col, TH) {
						// Hooks can return value other than number (for example `columnSorting` plugin use this).
						if (typeof col !== 'number') {
							return col;
						}

						if ((col == 0 || col == 6) && TH.childElementCount < 2) {
							TH.appendChild(getInitializedElements(col));
						}
					};

					// Deselect column after click on input.
					var doNotSelectColumn = function (event, coords) {
						if (coords.row === -1 && event.realTarget.nodeName === 'INPUT') {
							event.stopImmediatePropagation();
							this.deselectCell();
						}
					};
					var spreadsheetContainer = $("#spreadsheet")[0];

					if (typeof mapTable !== "undefined")
						mapTable.updateSettings({ data: [] }); //clear table after click

					var mapTable = new Handsontable(spreadsheetContainer, {
						data: maps,
						height: 1000,
						width: 800,
						colHeaders: header,
						columns: [{}, //map name
							{}, //tier
							{
								type: "time",
								timeFormat: "h:mm:ss"
							},
							{}, //tp
							{}, //pts
							{},
							{} //server
						],

						columnSorting: true,
						filters: true,
						autoColumnSize: {
							syncLimit: '40%'
						},
						className: 'typefilter',
						afterGetColHeader: addInput,
						beforeOnCellMouseDown: doNotSelectColumn,
						licenseKey: 'non-commercial-and-evaluation'
					});
				}); //end json
			}

			$("#getGlobalMapsButton").click(function () {

				var steamID = $('#steamIDText').val();

				if (!isValidSteamID(steamID)) {
					alert("invalid Steam ID!");
					return;
				}


				//remember logic is flipped, has teleports = true means TP
				ispro = $('input[name=isprorun-radio]:checked').val();
				teleports = true;
				if (ispro === "proradio")
					teleports = false;


				//set url to steamid and teleports for future use
				window.history.pushState("object or string", "Title", "?steamid=" + steamID + "&teleports=" +
					teleports);;
				retrieveStats(steamID, teleports);
			});


		});
	</script>


</head>

<body>
	<div class="nav-container">
		<ul>

			<li><a class="active" href="index.html">Global Maps</a></li>
			<li><a href="local.html">Local Maps</a></li>
			<li><a href="jumpstats.html">Jumpstats</a></li>

		</ul>
		<div class="center">

			<div id="titleDiv">
				<div id="innerTitleDiv">
					<h1>Your Times Across All Servers (under construction)</h1>
				</div>
			</div>

			<div class="innerSelection">


				<div class="innerSelection">
					<a href="https://steamid.io/lookup/">Look up your Steam ID</a><br>
				</div>
				Steam ID: <input type="text" id="steamIDText" name="steamID" Value="Enter your SteamID" />
				<input type="button" id="getGlobalMapsButton" value="Fetch Times" />
			</div>

			<div class="inputSelection">
				<div class="innerSelection">
					<input type="radio" name="isprorun-radio" value="tpradio" checked>TP Runs
					<input type="radio" name="isprorun-radio" value="proradio">Pro Runs

					<div id="playername"></div>
					</di>

				</div>
				<p>click on any header below to sort, tier information coming soon...</p>


				<div class="table-container" id="spreadsheet">


				</div>

			</div>
		</div>
</body>

</html>
